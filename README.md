Введение
В течение последнего года вокруг Ethereum было много шумакриптовалюта и не без причины. Смарт-контракты - это новая захватывающая концепция, введенная Ethereum. Что это? Ethereum - это распределенная книга (такая же, как биткойн), но эта книга может содержать не только счета и балансы, но и компьютерные программы. Программы являются гражданами первого класса в блок-цепочке Ethereum, и они не только хранятся на нем, но и предоставляют функции, которые могут быть вызваны (так же, как вы можете внести или снять деньги на счете в книге) и сохранить свое состояние в цепочке. Для разработчиков программного обеспечения было бы хорошей аналогией, что Ethereum Blockchain - это нечто похожее на виртуальную машину. Существует виртуальная машина с экземплярами объектов, которые хранятся в ее памяти (смарт-контракт). Экземпляры содержат не только код, который может быть выполнен, но и его состояние. Главное отличие состоит в том, что все хранится на распределенной книге вместо ОЗУ. Эта метафора не идеальна и немного упрощает, но это хорошая отправная точка.

Так умные контракты:

являются примерами контрактов, развернутых на блокчейне
имеют функции, которые могут быть вызваны из-за блокировки или другими интеллектуальными контрактами
как регулярные распределенные учетные записи: могут содержать, принимать и отправлять Ethereum
Blockchain управляется сетевыми узлами Ethereum. Чтобы взаимодействовать с ним, вам необходимо связаться с сетевым узлом Ethereum. Связь может быть прямой (с вашим собственным хостинговым узлом) или через прокси (есть такие проекты, как Metamask или Infura, которые обеспечивают доступ к существующим узлам Ethereum).

Pet проект
Потому что я программист, с того дня, как я услышал о смарт-контрактах, я очень хотел его использовать. Вот почему я решил написать платежные шлюзы для электронной коммерции. Я думаю, это может быть хорошей идеей, так как таким образом магазин электронной коммерции может обойти поставщиков платежей и их комиссионных. Кроме того, платежи могут производиться по всему миру быстрым, безопасным и анонимным способом. Вот пример того, как магазин электронной коммерции теперь работает с традиционным поставщиком платежей с точки зрения покупателя:

Я размещаю заказ в магазине электронной коммерции
Я перенаправляюсь к поставщику платежей (например, Paypal)
Я делаю платеж там (например, используя кредитную карту)
Я перенаправлен обратно в магазин электронной коммерции
Мой заказ изменяет свой статус на «платный»,
Мое намерение заключалось в том, чтобы сделать его таким же образом, просто чтобы заменить взаимодействие с поставщиком платежей с помощью смарт-контракта. Для этого мне понадобилось несколько строительных блоков:

Смарт-договор - написанный в твердой форме и развернутый на общественном блоке Ethereum blockchain
HTML-страница, которую клиент будет использовать для оплаты
Кусок кода, который позволит существующему магазину электронной коммерции общаться со смарт-контрактом, чтобы проверить статус оплаты.
Я назвал мой любимый проект Petunia, и вы можете найти его на github. Ниже я описал компоненты, которые я создал для достижения своей цели.

Умный договор
Существует множество языков, которые могут использоваться для написания смарт-контракта. Наиболее популярным является Solidityи это было основной причиной его выбора. Язык твердости довольно прост и позволяет выполнять основные операции над базовыми типами. Вы не найдете там даже строкового сравнения или манипуляции, и есть причина для этого. Код смарт-контракта выполняется сетью Ethereum (поэтому его можно запускать на всех узлах), поэтому он не может быть тяжелым. Код смарт-контракта хранится в блочной цепочке, поэтому все узлы должны хранить всю информацию о коде и его состоянии. Расчеты и хранение стоят дорого, и вы будете платить за это буквально. Сеть Ethereum представляет собой распределенную сеть узлов, которые вычисляют блокированные блоки (в терминах смарт-контракта это означает запуск кода и сохранение его изменений состояния), и эти узлы не делают это бесплатно. Для каждого вызова, который изменяет состояние цепочки, вам нужно заплатить. Валюта, используемая для оплаты изменений состояния цепочки, называется газом. Газ принимается шахтерами (узлами в сети, которые вычисляют следующие блоки) в качестве вознаграждения за их вычислительную мощность.

Достаточно теории, есть мой умный контракт. Я удалил детали реализации, чтобы не размыть его (полный код доступен здесь ).

Контракт Петуния является принадлежит {
contract Petunia is owned {

  //constructor
  function Petunia(address _billingAddress)

  function getStatus(uint externalPaymentId) constant returns (string)

  function getPrice(uint externalPaymentId) constant returns(uint)

  function startNewPayment(uint externalPaymentId, uint price) onlyOwner

  function pay(uint externalPaymentId) payable

  function complete(uint externalPaymentId) onlyOwner

  function refund(uint externalPaymentId) onlyOwner
}

Итак, поток для Petunia смарт-контракта:

Контракт развернут на блок-цепочке (это делается только один раз для каждого магазина электронной коммерции). _billingAddress хранится в смарт-контракте.
Когда клиент размещает заказ, магазин называет интеллектуальную контрактную функцию startNewPaymentс paymentId(идентификатор платежа генерируется магазином) и цена, которая должна быть оплачена. Это означает, что смарт-контракт предполагает, что ожидается новый платеж с заданным идентификатором и ценой.
Клиентские звонки (я объясню позже, как) payфункционируют с идентификатором платежа из магазина и с количеством Ethereum, которое необходимо оплатить. Смарт-контракт проверяет, соответствуют ли id и количество отправленных Ether. Если да, то он принимает платеж и изменяет статус.
Магазин электронной коммерции проверяет статус платежа (он вызывает getStatusфункцию), если статус Paidтогда, магазин электронной торговли отправит товар клиенту.
Наконец, магазин электронной торговли вызывает completeфункцию, и Ethereum от данного платежа переносится на платежный адрес. Теперь криптовые деньги находятся на счете магазина.
Существует также альтернативный путь, когда, например, заказный продукт недоступен, магазин электронной торговли будет вызывать функцию возврата и переводить деньги обратно на счет, который был использован клиентом. Вы получите код контракта, чтобы найти его в каталоге солидности, но если вы новичок в Ethereum, не погружайтесь там (сначала прочитайте сообщение).

Страница оплаты
Хорошо, но как клиент будет вызывать функцию на блочной цепочке? Я знаю, что это звучит страшно для среднего клиента электронной коммерции;) Но в наши дни это не так сложно, и в ближайшем будущем это станет еще более удобным. Итак, есть два способа сделать это:

Жесткий путь - запустить собственный сетевой узел Ethereum. Вам нужно скачать (Mist) [ https://github.com/ethereum/mist ] установить его, а затем дождаться, пока весь блок-код будет загружен на ваш компьютер. Затем откройте страницу оплаты в «Mist browser». Я предполагаю, что этот метод будет использоваться только компьютерными выродками.
Простой способ, установите расширение Metamask Chrome и откройте страницу оплаты. Metamask свяжется с существующими узлами Ethereum, поэтому нет необходимости устанавливать их на свой компьютер. Чтобы сделать платеж, вам, конечно, потребуется учетная запись с валютой Ethereum. Затем просто добавьте учетные данные учетной записи в Metamask. Затем нажмите кнопку «платить», и она будет готова.
Я записал, как это выглядит. [Видео]

Взаимодействие между веб-страницей (которая является простой старой HTML-страницей и страницей JavaScript) и блок-цепочкой выполняется с помощью библиотеки web3j JavaScript. Экземпляр Web3j предоставляется с помощью расширения Metamask chrome (или если вы используете Mist, Mist Browser), и это прокси-сервер для сети Ethereum. Это глобальная зависимость, как windowпеременная в веб-приложении. Web3j предоставляет все необходимые методы для взаимодействия с сетью Ehereum. Я использовал AngularJS в качестве основы для этой простой веб-страницы. В приведенном ниже коде создается EthClientсервис, который является экземпляром web3 и позволяет, например, получать учетные записи пользователей или создавать прокси для экземпляра контракта.

if (typeof web3 !== 'undefined' && typeof Web3 !== 'undefined') {
  web3 = new Web3(web3.currentProvider);
} else if (typeof Web3 !== 'undefined') {
  console.log('No web3? You should consider trying MetaMask!')
  web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
}

myApp.config(function ($provide) {
  $provide.provider('ethClinet', function () {
    this.$get = function () {
      return web3;
    };
  });
});

myApp.service('Petunia', ['ethClinet', '$q', function (ethClinet, $q) {
  //here we build object that represents petunia smart contract
  const petunia = ethClinet.eth.contract(contractABI).at(contractAddress);

  var account = null;
  //here we fetch accounts that are available e.g. were added to Metamask
  $q((resolve, reject) => ethClinet.eth.getAccounts(function (e, r) {
    if (e) {
      reject(e);
    } else {
      account = r[0];
    }
  }));
  ///...
});

Вы найдете остальную часть кода здесь . На моей странице оплаты проекта есть отдельная страница, на которую клиент будет перенаправлен, но имейте в виду, что это всего лишь код HTML, который также может быть встроен в магазин электронной коммерции.

Веб-сервис для электронной коммерции
Последняя часть, в которой мы нуждаемся, - это способ, которым наш магазин электронной коммерции будет связываться со смарт-контрактом. На самом деле это может быть что угодно, даже дополнительные строки кода в существующем магазине электронной коммерции. Однако я считаю, что сохранение его как отдельного веб-сервиса с REST-подобным API JSON может быть хорошей практикой. Я использовал NodeJS и Express для его создания, поскольку это был самый простой и быстрый способ сделать это, но он может быть написан на любом языке или технологии. Все, что вам нужно, это библиотека для общения с узлом Ethereum. Поэтому нам нужен узел Ethereum, у нас может быть свой собственный экземпляр или ваши сервисы, такие как Infura, чтобы общаться с чужими узлами (но обычно это стоит денег). Поскольку веб-службы являются областью программистов, для них было бы непростой задачей создать узел Ethereum и обмениваться данными с ним.

Код очень похож на веб-страницу, так как он также использует Web3js libary для взаимодействия с сетью Ethereum. Моя реализация наивна и не обеспечивает безопасность (это все-таки проект для домашних животных). Вы найдете его в каталоге веб-сервисов .

Веб-сервис предоставляет методы интеллектуального контракта через интерфейс HTTP JSON, который чрезвычайно прост в использовании любой электронной коммерцией. Магазин электронной коммерции будет использовать его для вызова startNewPaymentфункции на смарт-контракте, а затем для проверки состояния платежей и, наконец, для завершения или возврата платежа.

Стоимость бизнеса
Хорошо, но зачем использовать смарт-контракт в качестве поставщика платежей? Каковы плюсы и минусы с точки зрения бизнеса? Плюсы:

Плата за поставщиков нет, никаких зависимостей от сторонних организаций
Высокая доступность, отсутствие поддерживающих тормозов (возможно, кроме жесткой вилки один раз в год)
Легкие и быстрые платежи по всему миру
Прозрачность, клиент может проверить свой статус оплаты. Деньги хранятся на смарт договоре до тех пор, пока оплата не будет завершена.
Простые возмещения
Безопасность - фонды не могут быть украдены из смарт-контракта, они могут быть просто переведены в платежный аккаунт (указанный во время развертывания) или обратно клиенту (при возврате средств). Минусы:
Создание, изготовление и завершение оплаты расходов на газ и газ оплачивают фактические деньги (~ 0,01 ETH продавцом и ~ 0,032 ETH от покупателя). В отличие от платы поставщиков, эти сборы являются плоскими, поэтому не меняются с суммой платежа. Поскольку Ethereum стоит пару сотен долларов (а цена на газ выше, чем когда он был намного дешевле), это делает его слишком дорогостоящим для микро платежей.
Прозрачность - конкуренция может отслеживать транзакции нашего магазина электронной коммерции
Возможные юридические проблемы, поскольку криптотермии не регулируются во всех странах.

Выводы
Смарт-контракты кажутся очень перспективным решением, но, используя их, мы должны знать об их функциях, таких как прозрачность, хранение и расчет затрат. Не каждая проблема может (или стоит) быть решена с помощью смарт-контракта или решения, которое реализуется только с помощью смарт-контракта. Однако я считаю, что блокчлин и смарт-контракты станут частью других корпоративных систем и приложений (таких как Fizzy ).

Благодаря таким проектам, как Metamask и Infura, конечные пользователи (например, клиент интернет-магазина) должны иметь возможность использовать интеллектуальные контракты без каких-либо технических знаний, стоящих за блок-цепочкой Ethreum, и без необходимости запускать собственный узел Ethereum.

Что дальше?
Если это сообщение было интересно или вы хотели бы узнать больше о инструментах, которые я использовал, или просто хочу, чтобы я подробно рассказал о некоторых вариантах дизайна, оставьте комментарий. Вы можете найти интересную статью моего коллеги Кшиштофа Цеесельски о событиях Sourcing и умных контрактах . Если вы ищете разработчика или техническую команду для разработки или реализации решения blockchain, пожалуйста, свяжитесь со мной. Я работаю в SoftwareMill, и мы специализируемся на бэкэнд-решениях в различных технологических пакетах (от JavaScript до Scala).
